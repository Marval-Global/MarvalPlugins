<script src=Template.js></script><template><style>.pluginWrapper{display:none}.contactSearcher .telephone{width:86px}.MarvalSoftware-EntraCreation{display:none}.window .MarvalSoftware-EntraCreation{display:block}.MarvalSoftware-EntraCreation{position:absolute;top:0;bottom:0;left:0;right:0;border:none}.EntraCreationWindow{border:0}.MarvalSoftware-EntraCreation a{color:#3b73af}.MarvalSoftware-EntraCreation>.header{position:absolute;top:0;left:0;right:0;line-height:0}.MarvalSoftware-EntraCreation>.header>a{position:absolute;top:0;bottom:0;right:0;text-decoration:none;border:none}.MarvalSoftware-EntraCreation>.chatbot-container{position:fixed;bottom:20px;right:20px;width:350px;height:550px;border-radius:8px;overflow:hidden;display:none;z-index:1000}.chatbot-container iframe{width:100%;height:100%;border:none}</style></template><div class=MarvalSoftware-EntraCreation></div><script>!function(){var n=null,e=window.top.MarvalSoftware,t=window.top.$;e.Plugins.define("MarvalSoftware-Plugins-EntraCreation",{_pluginPath:null,_element:null,_imageElement:null,_contactEmail:"...",_pluginWindow:null,_fullPluginPathHandler:null,_requestActionMessageID:null,_popupBody:null,init:function(){n=this;var o,a,i="https://"+(o=window.top.location.host)+n._getPluginPath()+"Handler/Handler.ashx",s=t("#ctl00_ctl00_cph_entityHeaderText").text();if((o=window.top.location.href).includes("Plugin.aspx")&&"MarvalSoftware.Plugins.EntraCreation"==s){t("#ct100_overlay_id1").hide(),t("#ctl00_ctl00_cph_maintenance_worksWithMsm").removeClass("unsigned"),t("#ctl00_ctl00_cph_maintenance_worksWithMsm").addClass("signed"),a=!1,t.get("/MSM/RFP/Forms/RequestActionMessage.aspx",function(e){t(e).find("#ctl00_ctl00_ctl00_cph_existingEntitiesContentPlaceHolder_ExistingEntitiesList_loadMoreList_items a.item").each(function(){"Entra Integration Message - Automated"==t(this).attr("title")&&(a=!0,n._requestActionMessageID=t(this).attr("href").match(/id=(\d+)$/)[1])}),1==a?t("#pluginStatus").append('<br><span style="color:green">You have a request action message in your list of request action messages <a href="/MSM/RFP/Forms/RequestActionMessage.aspx" >here</a>, you do not need to install it.</span>'):t("#pluginStatus").append('<br><span style="color:red">You currently do not have the action message installed, click the button below to install it.<br>Once installed, it will appear in the list <a href="/MSM/RFP/Forms/RequestActionMessage.aspx">here</a> as an item called "Entra Integration Message - Automated</span>"')}).fail(function(){});var l=o.split("RFP"),r=t("#ctl00_ctl00_cph_maintenance_version").text(),c=l[0]+"RFP/Plugins/Marval%20Software/MarvalSoftware.Plugins.EntraCreation/"+r+"/Handler/Handler.ashx?tag=EntraCreation";t("#installation").after("<br><p><b>To use this plugin, put the following URL into Request Actions.</b><p><br>"+c+"<br> You also need to set a header with the Content-Type as application/x-www-form-urlencoded"),headerElem=t("#ctl00_ctl00_cph_entityHeaderText"),t("#ctl00_ctl00_cph_maintenance_quickFields").hide(),t(document).ready(function(){!async function(){var n="";try{if(!(n=await(await fetch("https://raw.githubusercontent.com/Marval-Global/EntraCreationPlugin/refs/heads/main/manifest.json")).json()))throw new Error(`Server responded with ${n.status} - ${n.statusText}`)}catch(n){throw console.error("Failed to load GitHub plugin version:",n),n}t("#ctl00_ctl00_cph_maintenance_version").text()==n.Version?(t("#ctl00_ctl00_cph_maintenance_version").css("color","green"),t("#ctl00_ctl00_cph_maintenance_version").css("font-weight","bold"),t("#uptodatemessage").fadeIn(250),setTimeout(()=>{t("#uptodatemessage").fadeOut(1e3)},2e3)):(t("#ctl00_ctl00_cph_maintenance_version").css("color","red"),t("#ctl00_ctl00_cph_maintenance_version").css("font-weight","bold"),t("#ctl00_ctl00_cph_maintenance_version").append(' - Plugin requires updating. Click <a href="https://github.com/Marval-Global/EntraCreationPlugin/releases/latest/download/MarvalSoftware.Plugins.EntraCreation.zip">here</a> for the new version.'))}(),async function(){var n=await(await fetch("/MSM/RFP/Forms/RequestActions.aspx")).text(),e=t("<div>").html(n).find("#ctl00_ctl00_ctl00_cph_ruleSetEditor_rules").val(),o=t("<textarea/>").html(e).text();try{var a=JSON.parse(o);let n=!1,e=0;a.forEach(o=>(e++,o.Actions.includes("MarvalSoftware.Plugins.EntraCreation/")&&o.Actions.includes(r)?(t("#pluginStatus").after('<br><div  style="color:green" id="RequestUsage">You are currently using the Entra Creation request action message in a request action.</div>'),void(n=!0)):o.Actions.includes("MarvalSoftware.Plugins.EntraCreation/")?(t("#pluginStatus").after('<br><div id="RequestUsage" style="color:green">You are currently using the Entra Creation request action message in a request action.</div>'),void(n=!0)):void 0)),e!==a.length||n||(t("#requestActionUsage").after('<div id="RequestUsage">You do not have a request action configured.<br>Click the button below to install it.<br>Once it is installed, click <a target="_blank" href="/MSM/RFP/Forms/RequestActions.aspx">here</a> and look for an item called "Entra Action Rule - Automated" </div>'),t("#RequestUsage").css("color","red"))}catch(n){console.error("Error parsing JSON:",n)}}(),async function(){let n=t("#ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl02_value").val();console.log("Have settings value as ",n),n||(t("#pluginStatus").css("color","red"),t("#pluginStatus").append("You have not yet configured your settings, please configure your settings before using the request actions integration."))}(),t("head").append('\n        <style>\n          .loadingSpinner {\n  width: 8px;\n  height: 8px;\n  border: 6px solid #3B73AF;       \n  border-top-color: #1696B7;       \n  border-radius: 50%;\n  animation: spin 0.8s linear infinite;\n  /* üé® optional centering helpers: */\n  display: inline-block;\n  vertical-align: middle;\n}\n\n\n@keyframes spin {\n  to { transform: rotate(360deg); }\n}\n\n          .hrefButton {\n            display: inline-block;\n            background-color: #1696B7;\n            color: #ffffff;\n            padding: 2px 12px;\n            text-decoration: none;\n            cursor: pointer;\n            border-radius: 4px;\n            font-weight: bold;\n            transition: background-color 0.3s;\n          }\n          .hrefButton:hover {\n            background-color: #0056b3;\n             color: #ffffff;\n          }\n.modalBox {\n  position: fixed;\n  inset: 0;\n  z-index: 9999;\n  display: none;                 /* toggle with JS */\n  place-items: center;\n  background: rgba(7, 63, 92, .60);   /* #073f5c with 60¬†% opacity */\n  backdrop-filter: blur(2px);\n}\n\n/* üóÇÔ∏è  Content card -------------------------------------------------------- */\n.modal-content {\n  width: min(600px, 90%);\n  background: #fff;\n  border-radius: 12px;\n  box-shadow: 0 8px 24px rgba(0,0,0,.25);\n  padding: 2.5rem 2.25rem;\n  animation: pop .35s ease;\n  position: relative;\n  font-family: "Segoe UI", Roboto, sans-serif;\n}\n\n/* üéÄ Header */\n.modal-content h2 {\n  margin: 0 0 1.25rem;\n  font-size: 1.5rem;\n  line-height: 1.2;\n  color: #073f5c;\n}\n.modal-content h2 span {\n  border-bottom: 3px solid #1696B7;\n  padding-bottom: .25rem;\n}\n\n.box {\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    padding: 1em;\n    margin-bottom: 1.5em;\n    background: #fafafa;\n  }\n  .box h3 {\n    margin-top: 0;\n  }\n  .or-text {\n    margin: 0 1em;\n    font-weight: bold;\n    vertical-align: middle;\n  }\n\n#isRequestActionMessageInstalled {\n  color: transparent;\n  transition: color 1s ease-in-out;\n}\n\n#requestActionUsage {\n  color: transparent;\n  transition: color 1s ease-in-out;\n}\n#RequestUsage\n{\ncolor: transparent;\n  transition: color 1s ease-in-out;\n}\n\n/* ‚úÖ Steps */\n.modal-steps {\n  margin: 0;\n  padding-left: 1.25rem;\n  list-style: disc;\n  color: #073f5c;\n}\n.modal-steps li {\n  margin-bottom: .9rem;\n}\n.modal-steps a {\n  color: #1696B7;\n  text-decoration: underline;\n}\n.modal-steps a:hover {\n  text-decoration: none;\n}\n\n\n.close {\n  position: absolute;\n  top: .75rem;\n  right: .75rem;\n  width: 32px;\n  height: 32px;\n  border: none;\n  background: #1696B7;\n  color: #fff;\n  font-size: 1.25rem;\n  line-height: 1;\n  border-radius: 50%;\n  cursor: pointer;\n  transition: background .2s ease;\n}\n.close:hover { background: #073f5c; }\n\n/* üìà Subtle pop-in */\n@keyframes pop {\n  0%   { transform: scale(.85); opacity: 0; }\n  100% { transform: scale(1);   opacity: 1; }\n}\n\n\n.modal-content {\n  display: flex;\n  flex-direction: column;\n  align-items: center;    /* horizontally center all direct children */\n  text-align: center;      /* center text inside headings, list items, etc. */\n  padding: 1.5rem;         /* optional, for a bit of breathing room */\n}\n\n.modal-content .modal-steps {\n  padding: 0;\n  list-style-position: inside; /* keep the bullets but centered */\n  margin: 1rem 0;\n}\n\n.modal-content input,\n.modal-content .hrefButton,\n.modal-content .close {\n  /* make sure buttons/inputs shrink to their contents */\n  display: inline-block;\n  margin: 0.5rem 0;\n}\n\n\n        </style>\n      '),function(){let n=t("#ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl00_value").val(),e=t("#ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl01_value").val(),o=t("#ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl02_value").val();console.log("Values are %s and %s and %s ",n,e,o),n&&""!==n.trim()?t("#pluginStatus").append('<br><span style="color:green">You have an App Registration configured.</span>'):t("#pluginStatus").append('<br><span style="color:red">You have no App Registration configured, please configure the application string in Step 1.</span>');e&&""!==e.trim()?t("#pluginStatus").append('<br><span style="color:green">You have a Marval API key configured.</span>'):(console.log("Marval api valuie is blank"),t("#pluginStatus").append('<br><span style="color:red">You have no Marval API key configured, please add a Marval API key below.</span>'));o&&""!==o.trim()?t("#pluginStatus").append('<br><span style="color:green">You have settings configured.</span>'):t("#pluginStatus").append('<br><span style="color:red">You have no settings configured, please click "Configure Settings" to configure the workflow status\'.</span>')}()}),t("#ctl00_ctl00_cph_maintenance_globalSettingsFieldSet").before('\n\n            <section class="box selection-section">\n              <h3>Plugin Status</h3>\n\n              <div id="pluginStatus"></div>\n\n              </section><br><br>\n\n\n  <section class="box selection-section">\n  <h3>Step 1: Choose one</h3>\n  <button class="hrefButton" id="getPluginSnippet">\n    Download Plugin PowerShell Snippet\n  </button>\n  <span class="or-text">or</span>\n  <button class="hrefButton" id="manualAppRegistration">\n    Manually Create App Registration\n  </button>\n</section>\n\n\x3c!-- Main Actions Box --\x3e\n<section class="box main-actions">\n  <h3>Step 2: Install & Configure</h3>\n\n  <button class="hrefButton" id="requestActionMessageInstall">\n    Install Request Action Message\n  </button>\n  <div id="isRequestActionMessageInstalled"></div>\n\n  <hr>\n\n  <button class="hrefButton" id="actionRuleInstall">\n    Install Request Action Rule\n  </button>\n  <div id="requestActionUsage"></div>\n\n  <hr>\n\n  <button class="hrefButton" id="configureSettings">\n    Configure Settings\n  </button>\n  <div class="configureSettingsText"></div>\n\n  <hr>\n\n  <button class="hrefButton" id="testPlugin">\n    Test Plugin\n  </button>\n  <div class="loadingSpinner" id="Testspinner" role="status" style="display:none" aria-label="Loading‚Ä¶"></div>\n  <span id="TestResponse"></span>\n\n  <hr>\n\n  <button class="hrefButton" id="viewInstallInstructions">\n    View Install Instructions\n  </button>\n\n\n</section>\n\n  \n    <br>\n  </div>\n\n <div id="installInstructionsModal" class="modalBox">\n  <div class="modal-content">\n    <button class="close" title="Close">&times;</button>\n\n    <h2><span>Installing the EntraCreation Request Action Plugin</span></h2>\n\n    <ul class="modal-steps">\n      <li>The first step in the plugin is to create a Service Principal in Azure. Click on the "Download Plugin Powershell Script" and run this against your Azure tenant.\n        This will generate a string that you can put into the box "Encrypted application string".\n      </li>\n\n      <li>On the plugin page, click on <strong>Install Request Action Message</strong> and select the options for your attributes.\n          Click on <strong>Install Request Action Rule</strong> to install the request action rule.\n         </li>\n\n      <li>Download the "Plugin Powershell Snippet" from the plugin page and use that on the Azure command line to create an App Registration.</li>\n\n      <li>The command will give you an encrypted string to place into the Global Settings section, the setting is called \'The encrypted application string.\n          </li>\n\n      <li>Click \'Test Plugin\'. This will decrypt the string and check that it is possible to decrypt the string and connect to Azure (the test makes no changes, it will only check a successful response).</li>\n    </ul>\n  </div>\n</div>\n\n <div id="manualAppRegistrationModal" class="modalBox">\n  <div class="modal-content">\n    <button class="close" title="Close">&times;</button>\n\n    <h2><span>Manually Installing the App Registration</span></h2>\n\n    <ul class="modal-steps">\n      <li>To run the entra plugin and authenticate to your Azure tenant, the plugin requires an app registration to be created in your Tenant. The details of the app registration are securely encrypted and stored in the plugin.\n      </li>\n\n           <input placeholder="TenantId" id="appRegistrationTenant"  type="text"></input><br>\n           <input placeholder="Application Client Id" id="appRegistrationAppId" type="text"></input><br>\n           <input placeholder="Client Secret" id="appRegistrationSecret" type="text"></input><br>\n<br>\n<b>Please ensure you have included the Application permission User.ReadWrite.All and granted admin consent to the application.</b><br><br>\n<button class="hrefButton" id="encryptDetails">Encrypt and Store in Plugin</button>\n      \n<br>\n    </ul>\n  </div>\n</div>\n\n<div id="downloadRequestActionModal" class="modalBox">\n  <div class="modal-content">\n    <button class="close" title="Close">&times;</button>\n<br>\n    <h2><span>Install the request action message</span></h2>\n <div class="form-group">\n      <label for="attributeTypeDropdownFirstname">Choose a request Attribute for First Name:</label><br>\n      <select id="attributeTypeDropdownFirstname">\n        <option>Loading‚Ä¶</option>\n      </select>\n    </div>\n<br>\n <div class="form-group">\n      <label for="attributeTypeDropdownLastname">Choose a request Attribute for Last Name:</label><br>\n      <select id="attributeTypeDropdownLastname">\n        <option>Loading‚Ä¶</option>\n      </select>\n    </div>\n    <br>\n    <div class="form-group">\n      <label for="attributeTypeDropdownEmail">Choose a request Attribute for Email:</label><br>\n      <select id="attributeTypeDropdownEmail" >\n        <option>Loading‚Ä¶</option>\n      </select>\n    </div>\n<br>\n\n   \x3c!-- <div class="form-group">\n       <label for="attributeTypeDropdownMailNickname">Choose a request Attribute for MailNickname:</label><br>\n       <select id="attributeTypeDropdownMailNickname" >\n         <option>Loading‚Ä¶</option>\n       </select>\n     </div> --\x3e\n<br>\n     <button class="hrefButton" id="InstallRequestActionMessage">\n        Install Request Action Message\n      </button>\n       <div class="loadingSpinner" id="InstallRequestActionMessageSpinner" role="status" style="display:none" aria-label="Loading‚Ä¶"></div>\n      <br><span id="InstalledRequestionActionMessageResponse"></span>\n      <br>\n      <ul class="modal-steps">\n       <li>\n      </li>\n    </ul>\n  </div>\n</div>\n\n\n<div id="configureSettingsModal" class="modalBox">\n  <div class="modal-content">\n    <button class="close" title="Close">&times;</button>\n<br>\n    <h2><span>Configure Settings</span></h2>\n <div class="form-group">\n      <label for="workflowStatusDropdownSuccess">Choose a workflow status for successful user creation:</label><br>\n      <select id="workflowStatusDropdownSuccess" >\n        <option>Loading‚Ä¶</option>\n      </select>\n    </div><br>\n\n    <div class="form-group">\n      <label for="workflowStatusDropdownNotSuccess">Choose a workflow status for unsuccessful user creation:</label><br>\n      <select id="workflowStatusDropdownNotSuccess" >\n        <option>Loading‚Ä¶</option>\n      </select>\n    </div>\n<br>\n     <button class="hrefButton" id="setConfiguration">\n        Set Configuration\n      </button>\n       <div class="loadingSpinner" id="setConfigurationSpinner" role="status" style="display:none" aria-label="Loading‚Ä¶"></div>\n      <br><span id="InstalledRequestionActionMessageResponse"></span>\n      <br>\n      <ul class="modal-steps">\n       <li>\n      </li>\n    </ul>\n  </div>\n</div>\n\n<div id="setupActionRuleModal" class="modalBox">\n  <div class="modal-content">\n    <button class="close" title="Close">&times;</button>\n<br>\n    <h2><span>Install the Request Action Rule</span></h2>\n    <br>\n  <p>This section rule is used to determine the criteria for running the request action rule to create a new Entra User.</p>\n  <p>You can modify this later directly in the request action rule.</p>\n  <br>\n <div class="form-group">\n      <label for="workflowDropdown">Choose a workflow for your request action rule:</label><br>\n      <select id="workflowDropdown">\n        <option>Loading‚Ä¶</option>\n      </select>\n    </div>\n<br>\n    <div class="form-group">\n      <label for="workflowStatusDropdown">Choose a workflow status for your request action rule:</label><br>\n      <select id="workflowStatusDropdown" >\n        <option>Loading‚Ä¶</option>\n      </select>\n    </div>\n<br>\n<br>\n     <button class="hrefButton" id="InstallRequestActionRule">\n        Install Request Action Rule\n      </button>\n       <div class="loadingSpinner" id="InstallRequestActionRuleSpinner" role="status" style="display:none" aria-label="Loading‚Ä¶"></div>\n      <br><span id="InstalledRequestionActionRuleResponse"></span>\n      <br>\n      <ul class="modal-steps">\n       <li>\n      </li>\n    </ul>\n  </div>\n</div>\n\n'),window.top.document.getElementById("requestActionMessageInstall").onclick=function(){event.preventDefault(),t("#downloadRequestActionModal").fadeIn(200),["Firstname","Email","Lastname"].forEach(n=>{fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getRequestAtributes"})}).then(async e=>{var o=await e.json(),a=t("#attributeTypeDropdown"+n);a.empty(),a.append('<option value="">-- Select an attribute --</option>'),o.forEach(n=>{let e=n.Name.split(" - "),o=e[1]?e[1]:n.Name;a.append(t("<option>").val(n.Identifier).text(o))})})})},window.top.document.getElementById("manualAppRegistration").onclick=function(){event.preventDefault(),t("#manualAppRegistrationModal").fadeIn(200)},window.top.document.getElementById("actionRuleInstall").addEventListener("click",function(){event.preventDefault(),t("#setupActionRuleModal").fadeIn(200),fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getRequestAtributes"})}),fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getWorkflowStatuses"})}).then(async n=>{var e=await n.json(),o=t("#workflowStatusDropdown");o.empty(),o.append('<option value="">-- Select a Workflow Status --</option>'),e.forEach(n=>{o.append(t("<option>").val(n.Identifier).text(n.Name))})}),fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getWorkflows"})}).then(async n=>{var e=await n.json(),o=t("#workflowDropdown");o.empty(),o.append('<option value="">-- Select a Workflow --</option>'),e.forEach(n=>{o.append(t("<option>").val(n.Identifier).text(n.Name))})})}),window.top.document.getElementById("viewInstallInstructions").onclick=function(){event.preventDefault(),t("#installInstructionsModal").fadeIn(200)},window.top.document.getElementById("installInstructionsModal").onclick=function(){event.preventDefault(),t("#installInstructionsModal").fadeOut(200)},window.top.document.getElementById("getPluginSnippet").onclick=function(){var e="https://"+window.top.location.host+n._getPluginPath()+"Handler/Handler.ashx";const o=encodeURI(e),a=new Blob([`\nConnect-AzAccount\n\n$displayName     = "Marval-Entra-Automation"\n$replyUrl        = "https://localhost"    \n$secretEndDate   = (Get-Date).AddYears(2)   \n$graphApiAppId   = "00000003-0000-0000-c000-000000000000" \n\n\n$mailSendAppPerm           = "b633e1c5-b582-4048-a93e-9f11b44c7e96"  \n$userReadWriteAllAppPerm   = "741f803b-c850-494e-b5df-cde7c675a1ca" \n\n\n$app = New-AzADApplication \`\n          -DisplayName     $displayName \`\n          -AvailableToOtherTenants:$false \`\n          -ReplyUrls       $replyUrl\n\n$sp  = New-AzADServicePrincipal -ApplicationId $app.AppId\n\n\nAdd-AzADAppPermission -ObjectId $app.Id \`\n                      -ApiId    $graphApiAppId \`\n                      -PermissionId $mailSendAppPerm \`\n                      -Type     Role\n\nAdd-AzADAppPermission -ObjectId $app.Id \`\n                      -ApiId    $graphApiAppId \`\n                      -PermissionId $userReadWriteAllAppPerm \`\n                      -Type     Role\n\n\n$secret = New-AzADAppCredential -ApplicationId $app.AppId -EndDate $secretEndDate\n\nWrite-Host "Client ID     : $($app.AppId)"\nWrite-Host "Client Secret : $($secret.SecretText)"\nWrite-Host "Secret expiry : $($secret.EndDateTime)"\n\n$tenantId         = (Get-AzContext).Tenant.Id\n$stringToEncrypt  = "$tenantId\`^$($app.AppId)\`^$($secret.SecretText)"\n\n$body = @{\n    action        = 'encrypt'\n    encryptString = $stringToEncrypt\n}\n\n$jsonBody = $body | ConvertTo-Json\n\n\n$responseEncrytped = Invoke-RestMethod \`\n    -Method       POST \`\n    -Uri          '${o}' \`\n    -Body         $jsonBody \`\n    -ContentType 'application/json'\n\nWrite-Host "Please put the encrypted text below into the Entra Creation Plugin" -ForegroundColor Green\n\nWrite-Host "$responseEncrytped" -ForegroundColor Green\n\nWrite-Host "You will also be required to grant admin consent to the newly created app registration" -ForegroundColor Green\n`],{type:"text/plain"}),i=URL.createObjectURL(a);t("<a>").attr({href:i,download:"createEntraAppRegistration.ps1"}).appendTo("body").get(0).click(),URL.revokeObjectURL(i)},window.top.document.getElementById("testPlugin").onclick=async function(){event.preventDefault(),t("#TestResponse").hide(),t("#Testspinner").show();var e="https://"+window.top.location.host+n._getPluginPath()+"Handler/Handler.ashx";try{var o=await(await fetch(e+"?endpoint=testPlugin")).json()}catch{t("#TestResponse").text("An unknown error occurred"),t("#TestResponse").css("color","red"),t("#TestResponse").show(),t("#Testspinner").hide()}o.error?(t("#TestResponse").text("Error "+o.error+" \n cooresponding appID is "+o.appID),t("#TestResponse").css("color","red"),t("#TestResponse").show(),t("#Testspinner").hide()):(t("#TestResponse").text("Token is Valid for appID "+o.appID+". Ensure that you have granted admin consent for the application."),t("#TestResponse").css("color","green"),t("#TestResponse").show(),t("#Testspinner").hide())},window.top.document.getElementById("InstallRequestActionMessage").onclick=async function(){event.preventDefault(),t("#InstallRequestActionMessageSpinner").show(),t("#InstalledRequestionActionMessageResponse").empty(),t("#InstalledRequestionActionMessageResponse").css("color","green");var e='\n@using System;\n@using Newtonsoft.Json;\n@{\n    var Lastname= "Lastname";\n    var email = "email";\n    var Firstname= "Firstname";\n}\n\n@{\nforeach (var item in Model.Attributes)\n{\n if (item.Type.Name == "[EMAIL]") {\n   email = @item.Value;\n}\n if (item.Type.Name == "[Firstname]") {\n   Firstname= @item.Value;\n}\n if (item.Type.Name == "[Lastname]") {\n   Lastname = @item.Value;\n}\n}\n\n@{\n    string RequestNumber = Model.RequestNumber;\n    var RequestNumberLength = Model.RequestNumber.Length;\n    var NewRequestNumber = "";\n}\n@{\n    for (var i = 0; i < RequestNumberLength; i++)\n    {\n        var stringnew = RequestNumber.Substring(i, 1);\n        NewRequestNumber = NewRequestNumber + " " + stringnew;\n    }\n}\n@{\n    var action = "EntraCreation";\n    var Message = "";\n\n@using Newtonsoft.Json;\n    var jsonData = new { Lastname= Lastname, action = action, email = email, Firstname= Firstname, requestId = @Model.Identifier};\n\nvar jsonString = JsonConvert.SerializeObject(jsonData, Formatting.Indented);\n}\n@jsonString\n                            ';[{token:"[Firstname]",selector:"#attributeTypeDropdownFirstname"},{token:"[Lastname]",selector:"#attributeTypeDropdownLastname"},{token:"[EMAIL]",selector:"#attributeTypeDropdownEmail"}].forEach(({token:n,selector:o})=>{const a=t(`${o} option:selected`).text();if(e=e.replace(n,a),"-- Select an attribute --"===a)return t("#InstalledRequestionActionMessageResponse").empty(),t("#InstalledRequestionActionMessageResponse").append("You must specify an attribute for each item"),t("#InstalledRequestionActionMessageResponse").css("color","red"),void t("#InstallRequestActionMessageSpinner").hide()});var o="https://"+window.top.location.host+n._getPluginPath()+"Handler/Handler.ashx";t("#InstallRequestActionMessage").attr("disabled",!0);var a=await(await fetch(o,{method:"POST",body:JSON.stringify({action:"createActionMessage",actionMessageText:e}),headers:[["content-type","application/json"]]})).json();t("#InstallRequestActionMessageSpinner").hide(),t("#InstallRequestActionMessage").attr("disabled",!1),t("#InstalledRequestionActionMessageResponse").append(a.response)},window.top.document.getElementById("InstallRequestActionRule").onclick=async function(){event.preventDefault(),t("#InstallRequestActionRule").attr("disabled",!0),t("#InstallRequestActionRuleSpinner").show(),t("#InstalledRequestionActionRuleResponse").empty(),t("#InstalledRequestionActionRuleResponse").css("color","green");var e=t("#workflowDropdown  option:selected").text(),o=t("#workflowStatusDropdown  option:selected").text();if("-- Select a Workflow --"===e||"-- Select a Workflow Status --"===o)return t("#InstalledRequestionActionRuleResponse").empty(),t("#InstallRequestActionRule").attr("disabled",!1),t("#InstalledRequestionActionRuleResponse").append("You must specify an attribute for each item"),t("#InstalledRequestionActionRuleResponse").css("color","red"),void t("#InstallRequestActionRuleSpinner").hide();{console.log("Selected is ",t("#workflowStatusDropdown option:selected"));var a=t("#workflowStatusDropdown option:selected").val(),s=t("#workflowDropdown option:selected").val();const e=encodeURI(i);var l=await(await fetch(i,{method:"POST",body:JSON.stringify({actionMessageId:n._requestActionMessageID,actionMessageURL:e,WorkflowStatusId:a,WorkflowId:s,action:"createActionRule"}),headers:[["content-type","application/json"]]})).json();t("#InstallRequestActionRuleSpinner").hide(),t("#InstallRequestActionRule").attr("disabled",!1),t("#InstalledRequestionActionRuleResponse").append(l.response)}},window.top.document.getElementById("configureSettings").onclick=function(){event.preventDefault();const n=window.top.document.getElementById("ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl02_value");let e;t("#configureSettingsModal").fadeIn(200);const o=n&&n.value?n.value.trim():"";if(o)try{e=JSON.parse(o)}catch(n){console.error("Invalid JSON in globalSettings value:",n),e={}}else e={},e.settings=[];const{success:a,notsuccess:s}=Object.assign({},...e.settings);fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getWorkflowStatuses"})}).then(async n=>{var e=await n.json(),o=t("#workflowStatusDropdownSuccess"),i=t("#workflowStatusDropdownNotSuccess");o.empty(),i.empty(),o.append('<option value="">-- Select a Workflow Status --</option>'),i.append('<option value="">-- Select a Workflow Status --</option>'),e.forEach(n=>{o.append(t("<option>").val(n.Name).text(n.Name)),i.append(t("<option>").val(n.Name).text(n.Name))}),a&&o.val(a),s&&i.val(s)})},window.top.document.getElementById("setConfiguration").onclick=function(){event.preventDefault(),console.log("Setting Configuration");let n=[];n.push({success:t("#workflowStatusDropdownSuccess option:selected").val()}),n.push({notsuccess:t("#workflowStatusDropdownNotSuccess option:selected").val()});let e={settings:n};console.log("Settings are ",e),window.top.document.getElementById("ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl02_value").value=JSON.stringify(e),t("#ctl00_ctl00_cph_apply_fakeApplyButton").click()},window.top.document.getElementById("encryptDetails").onclick=async function(){event.preventDefault(),console.log("Setting Configuration");let n=t("#appRegistrationTenant").val()+"^"+t("#appRegistrationAppId").val()+"^"+t("#appRegistrationSecret").val();console.log("String to encrypt is ",n),window.top.location.host;const e=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"encrypt",encryptString:n})}),o=await e.text();t("#ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl00_value").val(o),t("#ctl00_ctl00_cph_apply_fakeApplyButton").click()},t(".close").on("click",function(n){n.preventDefault(),console.log("Called close"),t("#installInstructionsModal").fadeOut(),t("#manualAppRegistrationModal").fadeOut(),t("#downloadRequestActionModal").fadeOut(),t("#setupActionRuleModal").fadeOut(),t("#configureSettingsModal").fadeOut()})}document.addEventListener("DOMContentLoaded",function(){t("#ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl00_value").val()&&(t("#installPlugin").hide(),t("#additionalInstructions").show(),t("#entracreationPluginActivated").hide());e.UI.Controls.ScriptManager.getInstance().getPage();var n=document.querySelector("template").content;this._element=window.top.document.importNode(n,!0),this._imageElement=this._element.querySelector("#MarvalSoftware-Plugins-EntraCreation")}.bind(this))},_hideField:function(n){var e=t("label").filter(function(){return t(this).text()==n}).parent().find("input").attr("id");t("#"+e).parent().hide()},_getFieldID:function(n){return t("label").filter(function(){return t(this).text()==n}).parent().find("input").attr("id")},_setRegion:function(n){t("label").filter(function(){return"@@Region"==t(this).text()}).parent().find("input").val(n),t("#ctl00_ctl00_cph_apply_fakeApplyButton").click()},_onDropdown:function(e,o){switch((e=t("label").filter(function(){return"@@AADObjectGUIDLocation"==t(this).text()}).parent()).find("select").val()){case"In Marval":e.find("input").val("entra");break;case"From Microsoft":e.find("input").val("microsoft");break;case"In an Attribute":e.find("input").val("attribute")}n._renderObjectLocationDropdown()},_getPluginPath:function(){return this.attributes["data-pluginpath"].value},_getPluginId:function(){return this.attributes["data-pluginid"].value},_getPluginCulture:function(){return this.attributes["data-pluginculture"].value},_getString:function(n,t){return e.Plugins.PluginResourceManager.getInstance().getString(this._getPluginId(),n,this._getPluginCulture(),t)},_getUserEmail:async function(){let n=t(await(await fetch("/MSM/RFP/Forms/Profile.aspx")).text());return null==n.find("#ctl00_cph_notifyMethod")||"Email"!=n.find("#ctl00_cph_notifyMethod").text()?"":n.find("#ctl00_cph_notifyAddress").text()},_onBtnClick:function(){event.preventDefault(),t("*").find(".initiate").prop("disabled",!0),n._startChat()},_disconnectChat:function(){event.preventDefault(),t("marvalsoftware-plugins-entracreation").parent().parent().fadeOut(300,function(){n._pluginWindow.hide()}),t("*").find(".chatbot-container").fadeOut(300,function(){t("*").remove(".chatbot-container")}),t("#EntraCreationPopup").remove()}})}()</script>
